% Chapter 4
\chapter{Transmission Expansion Planning by Quantum Annealing} % Main chapter title
\label{Chapter4} % For referencing the chapter elsewhere, use \ref{Chapter1} 
\section{Statement of the Problem}
The \textit{Transmission expansion planning} (TEP)\,\cite{Neumann2020TransmissionFlows} problem determines the number of new lines to be installed in order to achieve a specific goal, optimizing the performance of an energy system subject to the assumptions of a future scenario. It is classically formulated as a \textit{mixed integer linear programming} (MILP) problem that aims at finding the optimal way to expand the capacity of an energy system by minimizing the cost function, which is the sum of the investment cost of transmission lines and the operational cost of generators. It decides how many transmission lines to build and where to connect them in order to satisfy the energy demand on a distributed energy system with a high share of renewable energy sources. There are other components to build apart from transmission lines such as generators or storages, but considering them imply not only an increment in the number of variables of the problem but also an increment in its complexity. For this reason, the problem we are solving it is not completely realistic but it encapsulates the most important features of it. We should consider it just as a starting point to get insight about the problem formulation and challenges.\\\\
We can control the number of variables of the problem according to
\begin{itemize}
    \item \textbf{Number of nodes:} clustering techniques allow us to fix the number of nodes of the problem so that some loads of a given network are grouped acting as a single big load.
    \item \textbf{Snapshots of time}: in expansion problems it is common to consider hourly snapshots of time of one year, i.e., a total of 8760 snapshots. However, we can restrict the problem to a subset of snapshots without loss of generality.
    \item \textbf{Connectivity of transmission lines}: we can control the connectivity between nodes so that we do not allow a node the possibility of being fully connected with the rest of nodes. Furthermore, because of legal procedures to build new lines in areas where there are no transmission lines, TEP focuses on building lines in existing connections without changing the topology of the network.
    \item \textbf{Adding targets}: in this chapter we tackle a single target, i.e., the cost function -- investment and operational cost -- but there are other targets such as the increment of renewable energy sources in a given region or the reduction of the carbon footprint.
\end{itemize}
The resolution of MILP associated to TEP scales badly using classical algorithms\,\cite{Oertel2014ComplexityEvaluation} and, at the same time, energy system models are getting larger and more complex due to the integration of decentralized weather-dependent renewable energy sources, intermittent loads, sector coupling and the increase of storage components. Currently, the problem is often linearized or the scope and granularity of the model are reduced using clustering algorithms. For this reason, any computational time reduction will have substantial implications in closing the granularity gap between what the current models can solve and the desired resolution needed by energy system operators. However,  since quantum computers are still not sufficiently mature, large TEP problems cannot be solved fully by a quantum annealer. For this reason, we require hybrid methods\,\cite{Dilwali2016,Binato2001,Huang2019,MacRae2016,Zhao2021HybridProgrammingb} to decompose large problems into a master problem, which can be solved by a quantum annealer, and a sub-problem for which cutting-edge classical algorithms are going to be applied.\\\\
In this section we introduce the notation of the TEP problem. Let $N$ be the set of nodes of that network, $H$ the set of snapshots, $C$ the set of candidate transmission lines and $E$ the set of existing lines. Then $x_{kl}$, with $kl \in C$, represents the binary variable of the transmission line from node $k\in N$ to $l\in N$ -- it decides if that transmission line is built --, $d_{k}(h)$ represents the demand at node $k\in N$ in snapshot $h\in H$, $f_{kl}^{0}$  with $kl \in E$ represents the power flow being transmitted in existing line from node $k\in N$ to $l\in N$, $\bar{f}_{kl}^{0}$  with $kl \in E$ represents the maximum power flow being transmitted in existing line from node $k\in N$ to $l\in N$, $f_{kl}^{1}$  with $kl \in C$ represents the power flow being transmitted in candidate line from node $k\in N$ to $l\in N$, $\bar{f}_{kl}^{1}$  with $kl \in E$ represents the maximum power flow being transmitted in existing line from node $k\in N$ to $l\in N$, $g_{k}$ represents the energy produced at node $k\in N$, $\bar{g}_{k}$ represents the maximum energy production at node $k\in N$ and $r_{k}$ represents the load shedding, which can be thought as an artificial generator with a very big operational cost. Lastly, $c_{kl}$ is the coefficient of investment cost of transmission line from node $k \in N$ to $l \in N$, $c_{k}^{\text{oc}}$ is the operational cost of generator $k \in N$ and $c_{k}$ is the load shedding cost associated with $r_{k}$.
\begin{table}[H]
\centering
\begin{tabular}{|c||l|c|} 
 \hline	
 \textbf{Symbol} & \textbf{Description} & \textbf{Type} \\
 \hline	
 $N$ & Set of nodes of the network & Integer\\
  \hline	
  $H$ & Set of snapshots & Integer\\
  \hline
 $C$ & Set of candidate transmission lines & Integer\\
    \hline	
 $C_{k}$ & Set of candidate transmission lines from all nodes to node $k$ & Integer\\
  \hline	
 $E$ & Set of existing transmission lines & Integer\\
   \hline	
 $E_{k}$ & Set of existing transmission lines from all nodes to node $k$ & Integer\\
  \hline	
 $x_{kl}$ & Transmission line from node $k$ to $l$ & Binary\\
    \hline	
 $f_{kl}^{0}$ & Power flow in existing line from node $k$ to $l$ & Integer\\
     \hline	
 $\bar{f}_{kl}^{0}$ & Maximum power flow in existing line from node $k$ to $l$ & Integer\\
   \hline	
 $f_{kl}^{1}$ & Power flow in candidate line from node $k$ to $l$ & Integer\\
  \hline
 $\bar{f}_{kl}^{1}$ & Maximum power flow in candidate line from node $k$ to $l$ & Integer\\
 \hline
  $r_{k}$ & Shedding load at node $k$ & Integer\\
  \hline	
 $d_{k}(h)$ & Demand of node $k$ at snapshot $h$ & Integer\\
  \hline	
 $g_{k}(h)$ & Current generation at node $k$ at snapshot $h$ & Integer\\
  \hline	
 $\bar{g}_{k}$ & Maximum generation at node $k$ & Integer\\
   \hline
  $c_{kl}$ & Investment cost of transmission line from node $k$ to $l$ & Real\\
  \hline	
  $c_{k}^{(\text{oc})}$ & Annualised operational cost per MWh of generator $g_{k}$ & Real\\
  \hline
  $c_{k}$ & Cost of shedding load at node $k$ & Real\\
  \hline
\end{tabular}
\caption{Description of variables involved in TEP problems\,\cite{Dilwali2016}.}
\label{table:TEPNomenclature}
\end{table}
There are two ways of formulating the TEP, shown in Figure\,\ref{fig: ThreeNode}. On the one hand, the brownfield model considers the power flow of existing lines in a network $f_{kl}^{0}$ among with the power flow of a set of candidate lines $f_{kl}^{1}$. On the other hand, the greenfield model considers an empty network and a set of candidate lines $f_{kl}^{1}$. For simplicity, we are going to consider the greenfield approach so that we do not have to take into account the constants associated with the existing lines. We can map two indices $ij$ to a single index $k$ by using a bijective function for a given number of nodes $N$, see Ref.\,\cite{Jain2021SolvingComputer},
\begin{equation}
k(i,j,N) = \begin{cases}
    iN - i\left(i+1\right)/2 + j - (i+1), & i<j\\
    \text{None},& i=j \\
    k(j,i,N), & i>j
\end{cases}
    \label{eq: TwoIndexesmap}
\end{equation}
\begin{figure}[H]
  \begin{center}
\includegraphics[width=0.9\textwidth]{Figures/3NodeBrownGreen.pdf}
  \end{center}
  \caption{Three node example. \textbf{Left:} Network considering current transmission lines -- solid lines -- and candidate lines -- dashed lines --, brownfield model. \textbf{Right:} Network considering just candidate lines, greenfield model.}
  \label{fig: ThreeNode}
\end{figure}
Luckily, the \textit{dimod} python package from D-Wave allows us to work with two indices so that we do not need to use the previous function to reformulate the problem. We formulate the TEP problem according to the work of Dilwali \textit{et al.}\,\cite{Dilwali2016} as follows
\begin{mini!}[2]
	{\mathbf{x},\mathbf{g},\mathbf{r},\mathbf{f}^{0},\mathbf{f}^{1}}{\underbrace{\sum_{kl\in C}c_{kl}x_{kl}}_{\text{Investment cost}} + \underbrace{\sum_{h\in H}\sum_{k}c_{k}^{(\text{oc})}g_{k}(h)}_{\text{Operational cost}} + \underbrace{\sum_{h\in H}\sum_{k}r_{k}(h)c_{k}}_{\text{Load shedding cost}}}{\label{eq: objective}}{}{}
	\addConstraint{d_{k}(h)-\sum_{l\in E_{k}}f_{kl}^{0}(h) + \sum_{l\in C_{k}}f_{kl}^{1}(h) + g_{k}(h) + r_{k}(h)}{=0,}{\forall k\in N ,h\in H}{\label{const: PowerBalance}}
    \addConstraint{\abs{f_{kl}^{0}(h)} - \bar{f_{kl}^{0}}(h)}{\leq 0,\,}{\forall\, kl \in E,h\in H }{\label{const: ExistingLimits}}
     \addConstraint{\abs{f_{kl}^{1}(h)} - \bar{f_{kl}^{1}}(h)x_{kl}}{\leq 0,\,}{\forall\, kl \in C,h\in H }{\label{const: CandidateLimits}}
     \addConstraint{g_{k}(h)-\bar{g}_{k}(h)}{\leq 0,\,}{\forall\, k\in N,h\in H }{\label{const: BusLimits}}
    \addConstraint{r_{k}(h) - d_{k}(h)}{\leq 0,\,}{\forall\, k \in N,h\in H }{\label{const: BusLoads}}
    \addConstraint{\mathbf{d}, \mathbf{g}, \mathbf{f}^{0}, \mathbf{f}^{1}}{\geq 0,\,}{}{\label{const: positivevalues}}
    \addConstraint{x_{kl}}{\in \{0,1\},\,}{\forall\, kl \in C,}
\end{mini!}
where the variables are described in Table\,\ref{table:TEPNomenclature}. We next briefly describe each equation:
\begin{itemize}
    \item \textbf{Power balance Eq.\,\eqref{const: PowerBalance}}: it represents the power balance constraints, i.e., if the demand $d_{k}(h)$ at node $k$ and snapshot $h$ is fulfilled by the generator $g_{k}$ at node $k$ and the power flow incoming from other nodes $f_{kl}^{0}(h)$ and $f_{kl}^{1}(h)$. The term $r_{k}$ is the load shedding. It can be thought as an artificial generator whose operational cost is very big. It represents the fine for not fulfilling the demand in a node and it guarantees that the problem is feasible. To ensure that mathematically the demand is always fulfilled one can consider a load shedding term that is zero when demand at node $k$ is satisfied by the elements of the network and $r_{k} \neq 0$ when it is not fulfilled. If $r_{k} \neq 0$ the demand is not fulfilled, i.e., the electricity markets cannot offer the required energy to a given node and then pay a fine, which is an extra cost in the objective function. If the load shedding cost is high enough the demand is going to be always fulfilled since the load shedding term is the dominant term we want to minimize.
    \item \textbf{Existing circuit flow limits Eq.\,\eqref{const: ExistingLimits}}: the power flow of an existing transmission $f_{kl}^{0}$ line cannot exceed its maximum capacity, $\bar{f}_{kl}^{1}$.
    \item \textbf{Candidate circuit flow limits Eq.\,\eqref{const: CandidateLimits}}: the power flow of a candidate transmission line $f_{kl}^{1}$ cannot exceed its maximum capacity, $\bar{f}_{kl}^{1}$.
    \item \textbf{Node generation limits Eq.\,\eqref{const: BusLimits}}: the energy produced in a node $k$, $g_{k}$, cannot exceed its maximum energy production, $\bar{g}_{k}$.
    \item \textbf{Node loads limits Eq.\,\eqref{const: BusLoads}}: the load shedding at node $k$, $r_{k}$, cannot exceed the load $d_{k}$ of that node. 
\end{itemize}
The previous model is called a transport model since we are not considering Kirchoff's equations. Notice that we include the operational cost which is usually not included in the literature\,\cite{Gomes2019}. The reason for usually not including the operational cost is that other authors consider are considering a single snapshot so that the dominant term is the investment cost. However, if one wants to consider a large number of snapshots, then the operational cost is the dominant term. On the other hand, if we minimize the investment cost, then there is a change of building transmission lines that connect the most expensive generators to the nodes. In summary, extremal solutions lead to a high value of the cost function in one of the following ways:
\begin{itemize}
    \item \textbf{Underinvestment} leads to a high value of the total cost function because the system is not able to fulfill the demand $d(h)$.
    \item \textbf{Overinvestment} leads to a high value of the total cost function even though it satisfies the demand. Intuitively, we are creating more lines $\{x_{kl}\}$ than we need. Usually, there is an upper bound due to the capital budget.
\end{itemize}
The TEP combinatorial optimization problem is a trade-off between operational cost and investment cost where the optimal solution minimizes the investment cost and operational cost while fulfilling at the same time the constraints of the problem.\\\\
We can write the problem in Hamiltonian formulation by including the constraints as penalty terms,
\begin{align}
    \mathcal{H} = \sum_{kl\in C}c_{kl}x_{kl} + \sum_{h \in H}\sum_{k}c_{k}^{(\text{oc})}g_{k}(h)+ \sum_{h \in H}\sum_{k}c_{k}r_{k}(h)\\
    + P_{1}\left[\sum_{k}\sum_{h\in H}\left(\abs{f_{kl}^{0}(h)} - \bar{f_{kl}^{0}}(h)   \right)^{2}\right] +
    P_{2}\left[\sum_{k}\sum_{h\in H}\left(\abs{f_{kl}^{1}(h)} - \bar{f_{kl}^{1}}(h)\right)^{2}\right]\\
    + P_{3}\left[\sum_{k}\sum_{h\in H}\left(g_{k}(h)-\bar{g}_{k}(h)\right)^{2}\right].
\end{align}
Notice that there are only three penalty terms for the six constraints \eqref{const: PowerBalance}-\eqref{const: BusLoads}. The reason for this is the shedding load term that encapsulate three constraint in a single term in the objective function, the load shedding cost.\\\\
The investment cost $c_{kl}$ is the cost of building the transmission line $x_{kl}$ and it is a constant -- we are not considering time-dependent costs. Analogously, the operational cost $c_{j}^{(\text{oc})}$ represents the annualised cost per MWh of the produced energy $g_{k}(h)$ at snapshot $h$. For simplicity, we set the operational cost to each carrier -- wind turbine, solar or run of river among others -- to a fixed value -- mean cost of that carrier -- so that we do not have to consider the variation of the cost as function of the node or the time.\\\\
Notice, that the total cost depends on the investment cost and the operational cost. As stated before, the number of possible configurations of our problem scales badly. For this reason, knowing if we are considering a large set of snapshots -- large investment planning - or a small subset of snapshots gives us clues about what region of the configuration space we should explore. There are two regions to be considered:
\begin{itemize}
    \item \textbf{Large expansion planning:} for instance if we consider a 10 year expansion planning problem and we produce the energy with the cheapest carriers -- e.g. wind turbines -- we will reduce the operational cost drastically as compared with producing the energy with other carriers. However, it is possible that the fact of producing the energy with the cheapest carriers implies the need of building the most expensive transmission lines, hence increasing the investment cost.
    \item \textbf{Short expansion planning:} for instance if we consider a single-snapshot.  Then, it is clear that the minimum total cost function implies a minimum in the investment cost regardless of the operational costs, since the operational cost are lower as compared with the investment cost when there is only one snapshot to optimize over.
\end{itemize}
This trade-off between investment cost and operational cost is what determines the minimum value of the total cost function.\\\\
To summarise, given energy demand for a set of nodes $N$ for a set of snapshots $H$, the goal is to optimise the network so as to build the minimum amount of transmission lines -- minimizing in that way the investment cost -- while satisfying the energy demand for each snapshot. We are also taking into account the operational cost of each carrier so there is a trade-off between the investment cost of transmission lines and the operational cost of generators used to produce the energy to satisfy the demand.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%       SOLVING A SMALL PROBLEM WITH A REAL QUANTUM ANNEALER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Running a QUBO problem on D-WAVE's annealer}
 We are considering a single snapshot of a three node fully connected network with non-existing lines -- each node has a candidate to any other node of the network -- without the load shedding term.\\
The investment costs of some candidate lines are not considered in public data of IEEE because usually the TEP considers adding lines to the existing building lines. For this reason, we used synthetic data for our TEP problem.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%       BENDERS DECOMPOSITION for TEP [Large Problems]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Benders Decomposition in TEP}
In Ch.\,\ref{Chapter3} we showed three hybrid approaches that combine classical and quantum solvers. In this work, we decided to explore the Benders' decomposition approach due to two main points. Firstly, the convergence properties of Benders' decomposition allows us to know how good a solution is. Secondly, TEP problems have diagonal structure which means they are suitable for a Benders' decomposition approach.\\\\\
In order to simplify the problem we consider a single snapshot so that we can drop the $h$ index. As discussed in Ch.\,\ref{Chapter3}, we can formulate the problem by maximizing a dual function or by minimizing the primal problem with the dual as penalties. The Benders' decomposition algorithm that we propose consists of four steps:
\begin{itemize}
    \item \textbf{Step 1} (\textit{Initialization of Bendersâ€™ decomposition})\textbf{:} We initialize the iteration counter $t$, the upper bound $\bar{z}^{0}$, the lower bound $\underline{z}^{0}$, the load shedding and operational cost $\alpha^{0}$ and the penalty term associated with the violation of power flow constraints of candidate lines $\Pi_{f_{kl}^{1}}$.
    \item \textbf{Step 2} (\textit{Master problem solved by a quantum annealer})\textbf{:} We maximize the lower bound $\underline{z}^{t}$ by taking the minimum value of 
    \begin{equation}
      \min \underline{z}^{t} \leq \sum_{kl\in C}c_{kl}x_{kl}^{t} + \alpha^{t-1} - \sum_{kl\in C}\Pi^{t-1}_{f_{kl}^{1}}\left(x_{kl}^{t} - x_{kl}^{t-1}\right),  
    \end{equation}
    where the RHS increases its value in each iteration. In other words, the RHS represents the Benders' cuts.
    \item \textbf{Step 3} (\textit{Slave problem solved by a classical solver})\textbf{:} We minimize $\alpha^{t}$ which includes the load shedding cost and the operational cost. After minimizing $\alpha^{t}$ we minimize the upper bound
    \begin{equation}
        \bar{z}^{t} = \min \{\bar{z}^{t-1}, \sum_{kl \in C}c_{kl}x_{kl}^{t} + \alpha^{t}\}.
    \end{equation}
    \item \textbf{Step 4} (\textit{Stopping criterion})\textbf{:} If the difference between the upper and lower bound is less or equal than a given threshold
    \begin{equation}
        \bar{z} - \underline{z} \leq \epsilon,
    \end{equation}
    then the Benders' algorithm stops and outputs the value of $\{\mathbf{x},\mathbf{g},\mathbf{r},\mathbf{f^{1}}\}$ as the (sub-)optimal solution. Otherwise, it goes to step 2 with the new candidate solution as input.
\end{itemize}

\begin{figure}
    \centering
    \begin{tcolorbox}[colback=white!5!white,colframe=black!75!black,title=Benders' decomposition algorithm]
    \begin{tcolorbox}[colback=black!5!white,colframe=black!75!black,title= \textbf{Step 1:} Initialization of Benders' decomposition]
    \begin{align}
    t &= 1 & \text{Benders' iteration} \\
    \underline{z}^{0} &= -\infty & \text{Lower bound}\\
    \bar{z}^{0} &= \infty & \text{Upper bound} \\
    \alpha^{0} &= 0 & \text{Load shedding and operational cost} \\
    \Pi_{f_{kl}^{1}}^{0} &= 0 \quad \forall kl\in C & \text{Lagrange multipliers}
    \end{align}
    \end{tcolorbox}
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \begin{tcolorbox}[colback=blue!5!white,colframe=blue!75!black,title= \textbf{Step 2:} Master problem solved by a quantum annealer]
    \begin{mini!}[2]
	{\mathbf{x}^{t}}{\underline{z}^{t}}{}{}{}
	\addConstraint{\underline{z}}{\leq  \sum_{kl\in C}c_{kl}x_{kl}^{t} + \alpha^{t-1} - \sum_{kl\in C}\Pi^{t-1}_{f_{kl}^{1}}\left(x_{kl}^{t} - x_{kl}^{t-1}\right)}{}{}
    \addConstraint{x_{kl}}{\in \{0,1\},\,}{\forall\, kl \in C}.
    \end{mini!}
    \end{tcolorbox}
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \begin{tcolorbox}[colback=red!5!white,colframe=red!75!black,title=\textbf{Step 3:} Slave problem solved by a classical solver]
    \begin{mini!}[2]
	{\mathbf{g},\mathbf{r}, \mathbf{f}^{0}, \mathbf{f}^{1}}{\alpha^{t} \equiv \underbrace{\sum_{k}c_{k}^{(\text{oc})}g_{k}}_{\text{Operational cost}} + \underbrace{\sum_{k}r_{k}c_{k}}_{\text{Load shedding cost}}}{}{}{}
	\addConstraint{d_{k}-\sum_{l\in E_{k}}f_{kl}^{0} + \sum_{l\in C_{k}}f_{kl}^{1} + g_{k} + r_{k}}{=0,}{\forall k\in N }{}
    \addConstraint{\abs{f_{kl}^{0}} - \bar{f_{kl}^{0}}}{\leq 0,\,}{\forall\, kl \in E}{}
     \addConstraint{\abs{f_{kl}^{1}} - \bar{f_{kl}^{1}x^{t}_{kl}}}{\leq 0,\,}{\forall\, kl \in C}{}
     \addConstraint{g_{k}-\bar{g}_{k}}{\leq 0,\,}{\forall\, k\in N}{}
    \addConstraint{r_{k} - d_{k}}{\leq 0,\,}{\forall\, k \in N}{}.
    \end{mini!}
    \begin{align}
    \bar{z}^{t} &=\min \{\bar{z}^{t-1}, \sum_{kl\in C}c_{kl}x_{kl}^{t} + \alpha^{t}\} & \text{Update upper bound}
    \end{align}
    \end{tcolorbox}
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \begin{tcolorbox}[colback=black!5!white,colframe=black!75!black,title=\textbf{Step 4:} Stopping criterion]
    If $\left(\bar{z}^{t} - \underline{z}^{t}\right)/\bar{z}^{t}\leq \epsilon$, then we found the (sub)-optimal solution, else $t=t+1$ and we have to repeat the algorithm from step 2 until the stopping criterion is satisfied.
    \end{tcolorbox}
    \end{tcolorbox}
    \caption{Quantum-classical Benders' decomposition algorithm diagram of TEP problem. It uses a quantum solver to solve the MP and a classical solver for the SP.}
    \label{fig:BendersSchemeTEP}
\end{figure}


